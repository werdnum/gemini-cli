# Streaming JSON Protocol

The Gemini CLI supports a streaming JSON output format using the
`--output-format=stream-json` flag. This format emits a stream of
newline-delimited JSON (JSONL) events, allowing consumers to process output in
real-time as it is generated by the model.

## Protocol Overview

- **Format**: Newline-delimited JSON (JSONL).
- **Structure**: Each line contains a complete JSON object representing a single
  event.
- **Encoding**: UTF-8.

## Usage

To enable streaming JSON output, run the CLI with the
`--output-format=stream-json` flag:

```bash
gemini --output-format=stream-json "Your prompt here"
```

## Event Types

The protocol defines several event types to represent the lifecycle of a session
and the interactions within it.

### `init`

Emitted at the start of a session.

**Schema:**

```json
{
  "type": "init",
  "timestamp": "string (ISO 8601)",
  "session_id": "string",
  "model": "string"
}
```

**Example:**

```json
{
  "type": "init",
  "timestamp": "2023-10-27T10:00:00.000Z",
  "session_id": "session-123",
  "model": "gemini-pro"
}
```

### `message`

Emitted for chat messages, including user input and assistant responses. For
assistant responses, content may be streamed in chunks (deltas).

**Schema:**

```json
{
  "type": "message",
  "timestamp": "string (ISO 8601)",
  "role": "user" | "assistant",
  "content": "string",
  "delta": boolean (optional)
}
```

**Example (User Input):**

```json
{
  "type": "message",
  "timestamp": "2023-10-27T10:00:01.000Z",
  "role": "user",
  "content": "Hello, how are you?"
}
```

**Example (Assistant Response - Delta):**

```json
{"type":"message","timestamp":"2023-10-27T10:00:02.000Z","role":"assistant","content":"I am ","delta":true}
{"type":"message","timestamp":"2023-10-27T10:00:02.100Z","role":"assistant","content":"doing well.","delta":true}
```

### `tool_use`

Emitted when the model requests to execute a tool.

**Schema:**

```json
{
  "type": "tool_use",
  "timestamp": "string (ISO 8601)",
  "tool_name": "string",
  "tool_id": "string",
  "parameters": { ... }
}
```

**Example:**

```json
{
  "type": "tool_use",
  "timestamp": "2023-10-27T10:00:03.000Z",
  "tool_name": "calculator",
  "tool_id": "call_1",
  "parameters": { "expression": "2+2" }
}
```

### `tool_result`

Emitted after a tool has been executed.

**Schema:**

```json
{
  "type": "tool_result",
  "timestamp": "string (ISO 8601)",
  "tool_id": "string",
  "status": "success" | "error",
  "output": "string" (optional),
  "error": { (optional)
    "type": "string",
    "message": "string"
  }
}
```

**Example (Success):**

```json
{
  "type": "tool_result",
  "timestamp": "2023-10-27T10:00:04.000Z",
  "tool_id": "call_1",
  "status": "success",
  "output": "4"
}
```

**Example (Error):**

```json
{
  "type": "tool_result",
  "timestamp": "2023-10-27T10:00:04.000Z",
  "tool_id": "call_1",
  "status": "error",
  "error": { "type": "ValueError", "message": "Invalid expression" }
}
```

### `error`

Emitted for non-fatal errors or warnings during processing.

**Schema:**

```json
{
  "type": "error",
  "timestamp": "string (ISO 8601)",
  "severity": "warning" | "error",
  "message": "string"
}
```

**Example:**

```json
{
  "type": "error",
  "timestamp": "2023-10-27T10:00:05.000Z",
  "severity": "warning",
  "message": "Loop detected, stopping execution"
}
```

### `result`

Emitted at the end of the session, containing the final status and statistics.

**Schema:**

```json
{
  "type": "result",
  "timestamp": "string (ISO 8601)",
  "status": "success" | "error",
  "error": { (optional)
    "type": "string",
    "message": "string"
  },
  "stats": { (optional)
    "total_tokens": number,
    "input_tokens": number,
    "output_tokens": number,
    "cached": number,
    "input": number,
    "duration_ms": number,
    "tool_calls": number
  }
}
```

**Example (Success):**

```json
{
  "type": "result",
  "timestamp": "2023-10-27T10:00:06.000Z",
  "status": "success",
  "stats": {
    "total_tokens": 100,
    "input_tokens": 50,
    "output_tokens": 50,
    "cached": 0,
    "input": 50,
    "duration_ms": 6000,
    "tool_calls": 1
  }
}
```

**Example (Error):**

```json
{
  "type": "result",
  "timestamp": "2023-10-27T10:00:06.000Z",
  "status": "error",
  "error": { "type": "FatalError", "message": "Something went wrong" }
}
```
